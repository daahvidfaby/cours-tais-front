<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Question 3</title>
  </head>
  <body>


    <script src="jquery-3.1.1.min.js"></script>
    <script src="api.js"></script>

    <script>

    var Player = (function() {

      var self = {},
          model = {
            status: 'Playing',
            songs: [],
            songIndex: 0
          },
          isReady = false;


          self.init = function(containerName) {
            createContainer(containerName);
            createElements();
            initListeners();
            initWidget();
            renderModel();
          }

          function createContainer(containerName) {
            $('body').prepend($('<div>').addClass(containerName));
            self.container = '.'+containerName;
          }

          function createElements() {
            var elements = {
              status: $('<div>').addClass('status').text('Status : ' +model.status),
              song: $('<div>').addClass('song').text('Chanson : '),
              play: $('<button>').addClass('play').text('Play'),
              pause: $('<button>').addClass('pause').text('Pause'),
              prev: $('<button>').addClass('prev').text('Prev'),
              next: $('<button>').addClass('next').text('Next'),
            }

            $.each(elements, function(index, value) {
              $(self.container).append(value);
            });
          }

          function initListeners() {
            $(self.container).find('button').click(function() {
              updateModel($(this).attr('class'));
              renderModel();
            });
          }

          function initWidget() {
            $(self.container).prepend($('<iframe>').attr({
               'width':"100%",
               'height':"450",
               'scrolling':"no",
               'frameborder':"no",
               'src':"https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/users/142546852&amp;auto_play=false&amp;hide_related=false&amp;show_comments=true&amp;show_user=true&amp;show_reposts=false&amp;visual=true"
            }));
            self.widget = SC.Widget($(self.container +' iframe')[0]);
            getSongs();
          }

          function getSongs() {
// NOTATION: Je pense que tu aurais pu extraire ce bout de code dans une fonction isReady(callback),
// qui retourne true ou false tout de suite, et qui rappelle callback quand le widget est ready
            if (!isReady) {
              self.widget.bind(SC.Widget.Events.READY, function() {
                isReady = true;
                getSongs();
              });
              return;
            }
            self.widget.getSounds(function(sounds) {
              model.songs = [];
              $.each(sounds, function(index, sound){
                model.songs.push({
                  artist: sound.user.username,
                  song: sound.title
                })
              });
            });
            console.log(model);
          }




          function updateWidget(){
// NOTATION: Je pense que tu aurais pu extraire ce bout de code dans une fonction isReady(callback),
// qui retourne true ou false tout de suite, et qui rappelle callback quand le widget est ready
              if (!isReady) {
                self.widget.bind(SC.Widget.Events.READY, function() {
                  isReady = true;
                  updateWidget();
                });
                return;
              }
              if(model.status == 'Playing'){
                self.widget.isPaused(function(status) {
                  if(status === true){
                    self.widget.play();
                  }
                });
              } else if(model.status == 'Paused'){
// NOTATION: Je pense que dans ce cas si aussi, il faudrait vérifier que le widget est pas déjà en pause
                self.widget.pause();
              }
              self.widget.getCurrentSoundIndex(function(index) {
                if(index != model.songIndex){
                  self.widget.skip(model.songIndex);
                }
              });
          }

          function updateModel(type) {
            switch(type){
              case 'play':
                model.status = 'Playing';
                break;
              case 'pause':
                model.status = 'Paused';
                break;
              case 'prev':
                if(model.songIndex > 0){
                  model.songIndex -= 1;
                    model.status = 'Playing';
                }
                break;
              case 'next':
                self.widget.getSounds(function(sounds) {
// NOTATION: Tu ne gères pas le cas ou la chanson est changée "toute seule",
//il faudrait que tu te bind sur SC.Widget.Events.PLAY_PROGRESS — fired periodically while the sound is playing,
// pour savoir quand une chanson change
                  if(model.songIndex < sounds.length){
                    model.songIndex += 1;
                    model.status = 'Playing';
                  }
                });
                break;
            }
          }

          function renderModel() {
            $(self.container).find('.status').text('Status : ' +model.status);
            $(self.container).find('.song').text('Chanson : ' + model.songs[model.songIndex].artist + ' - ' + model.songs[model.songIndex].song);
            updateWidget();
          }

          return self;
    })();

    Player.init('container');


    </script>

  </body>
</html>
